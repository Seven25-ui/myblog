<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Seven33 Feed</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  --sky:#38bdf8;
  --sky-dark:#0284c7;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --bg:#f0f9ff;
}

/* RESET */
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial, Helvetica, sans-serif;}
body{background:var(--bg); color:var(--text); padding-bottom:70px;}

/* TOP NAV */
.top-nav{
  display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
  padding:12px 15px; background:var(--card); box-shadow:0 3px 8px rgba(0,0,0,.08);
  position:sticky; top:0; z-index:100;
}
.top-nav .hamburger{font-size:22px; cursor:pointer; position:relative;}
.top-nav .logo{font-weight:bold; font-size:20px; color:var(--sky-dark);}
.top-nav .actions{display:flex; flex-wrap:wrap; gap:6px;}
.top-nav .actions a{ text-decoration:none; color:white; padding:6px 12px; border-radius:20px; font-size:14px;}
.top-nav .actions .add-post{background:var(--sky);}
.top-nav .actions .add-post:hover{background:var(--sky-dark);}
.top-nav .actions .logout{background:#ef4444;}
.top-nav .actions .logout:hover{background:#dc2626;}

/* HAMBURGER DROPDOWN */
.dropdown{
  display:none;
  position:absolute;
  top:40px;
  left:0;
  background:var(--card);
  border:1px solid #cbd5f5;
  border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,.1);
  flex-direction:column;
}
.dropdown a{
  padding:8px 12px;
  text-decoration:none;
  color:var(--text);
  font-size:14px;
}
.dropdown a:hover{background:#e0f2fe; color:var(--sky-dark);}

/* TABS */
.tabs{
  display:flex; justify-content:flex-start;
  background:var(--card); padding:10px 0;
  box-shadow:0 2px 5px rgba(0,0,0,.05);
  position:sticky; top:56px; z-index:90;
  overflow-x:auto; scroll-behavior:smooth;
}
.tabs::-webkit-scrollbar{display:none;}
.tabs a{flex:0 0 auto; text-decoration:none; color:var(--muted); font-weight:bold; font-size:14px; padding:0 12px;}
.tabs a.active{color:var(--sky-dark); border-bottom:2px solid var(--sky); padding-bottom:2px;}

/* POSTS */
.card{
  background:var(--card);
  padding:18px;
  margin:18px auto 0 auto;
  border-radius:16px;
  box-shadow:0 6px 20px rgba(0,0,0,.05);
  max-width:600px;
  width:90%;
}
.card h3{margin-bottom:6px;color:var(--sky-dark);}
.card small{color:var(--muted);}
.profile{display:flex; align-items:center; gap:10px; margin-bottom:10px;}
.profile img{width:45px;height:45px;border-radius:50%;border:2px solid var(--sky);object-fit:cover;}
.comment{font-size:14px;margin:4px 0;}
.reactions button{background:#e0f2fe;color:#0369a1;border-radius:50%;padding:6px 10px;border:none;cursor:pointer;font-weight:bold;transition:.2s;}
.reactions button:hover{background:#bae6fd;}
button{padding:6px 12px;background:var(--sky);color:#fff;border:none;border-radius:20px;cursor:pointer;font-size:14px;margin-top:5px;}
form input{width:100%; padding:8px 10px; margin-top:6px; border-radius:10px; border:1px solid #cbd5f5;}
form input:focus{outline:none; border-color:var(--sky);}

/* BOTTOM NAV */
.bottom-nav{
  position:fixed; bottom:0; left:0; width:100%; height:60px; background:var(--card);
  border-top:1px solid #cbd5f5; display:flex; justify-content:space-around; align-items:center; box-shadow:0 -3px 10px rgba(0,0,0,.05); z-index:1000;
}
.bottom-nav a{
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  color: var(--muted);
  font-size: 12px;
  gap: 4px;
}
.bottom-nav a:hover, .bottom-nav a.active{color: var(--sky-dark);}
.bottom-nav .icon{width: 24px; height: 24px;}

/* Back to Home button */
#backHomeBtn{
  position:fixed; bottom:70px; right:15px; padding:10px 16px; background:var(--sky); color:#fff; border:none; border-radius:20px; cursor:pointer; font-weight:bold; display:none; z-index:1001;
}

/* PROFILE INLINE */
#profile-section{max-width:600px;margin:20px auto;padding:15px;background:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.05);}
#profile-section img{width:80px;height:80px;border-radius:50%;border:3px solid var(--sky);}
#profile-section input{margin-top:10px;}
#profile-section button{margin-top:10px;}

/* MOBILE */
@media (max-width:500px){
  .top-nav .logo{font-size:18px;}
  .top-nav .actions a{font-size:12px; padding:5px 10px;}
  .card h3{font-size:16px;}
  .card p, .card small, .comment{font-size:12px;}
  .tabs a{font-size:12px; padding:0 10px;}
}
</style>
<script>
function toggleDropdown(){
  const drop = document.getElementById('hamburgerDropdown');
  drop.style.display = drop.style.display === 'flex' ? 'none' : 'flex';
}

let page = {discover:1, following:1, videos:1, profile:1};

function showBackButton(show){
  const btn = document.getElementById('backHomeBtn');
  btn.style.display = show ? 'block' : 'none';
}

// Load tab content
function loadTab(tab, reset=false){
  document.querySelectorAll('.tabs a').forEach(el=>el.classList.remove('active'));
  document.querySelector(`.tabs a[href="#${tab}"]`)?.classList.add('active');

  const feed = document.getElementById('feed');
  if(reset) feed.innerHTML="";

  if(tab==="discover" || tab==="following" || tab==="videos" || tab==="profile"){
    let url = tab==="profile" ? "/feed/profile" : `/feed/${tab}?page=${page[tab]}`;
    fetch(url)
      .then(res=>res.json())
      .then(posts=>{
        if(tab==="profile"){
          // Add profile edit section on top
          const profileHTML = `
            <div id="profile-section">
              <img id="profile-pic" src="{{ session.profile_pic }}">
              <input type="text" id="username-input" value="{{ session.username }}">
              <input type="file" id="profile-file">
              <button onclick="saveProfile()">Save</button>
            </div>
          `;
          feed.innerHTML = profileHTML;
        }
        posts.forEach(post=>{
          const div = document.createElement('div');
          div.className='card';
          div.innerHTML = `
            <div class="profile">
              <img src="${post.profile_pic}" alt="Profile Pic">
              <strong>${post.username}</strong>
            </div>
            <h3>${post.title}</h3>
            <p>${post.content}</p>
            <small>${post.timestamp}</small>
            <div class="reactions" style="margin-top:8px; display:flex; gap:10px;">
              <button onclick="react(${post.id},'üëç')"> üëç ${post.reactions.filter(r=>r.emoji==='üëç').length}</button>
              <button onclick="react(${post.id},'‚ù§Ô∏è')">‚ù§Ô∏è ${post.reactions.filter(r=>r.emoji==='‚ù§Ô∏è').length}</button>
              <button onclick="react(${post.id},'üòÇ')"> üòÇ ${post.reactions.filter(r=>r.emoji==='üòÇ').length}</button>
            </div>
            <div style="margin-top:12px;">
              <form action="/add_comment/${post.id}" method="post" class="comment-form">
                <input type="text" name="comment" placeholder="Write a comment..." required>
                <button type="submit">Comment</button>
              </form>
              ${post.comments.map(c=>`<div class="comment">üí¨ <b>${c.username}</b>: ${c.content}</div>`).join('')}
            </div>
          `;
          feed.appendChild(div);
        });
        if(posts.length>0) page[tab]++;
        showBackButton(tab!=="discover");
      });
  } else {
    feed.innerHTML = `<h3 style="text-align:center; margin-top:40px;">${tab.charAt(0).toUpperCase()+tab.slice(1)} Page</h3>`;
    showBackButton(true);
  }
}

// AJAX profile save
function saveProfile(){
  const formData = new FormData();
  formData.append("username", document.getElementById("username-input").value);
  const fileInput = document.getElementById("profile-file");
  if(fileInput.files[0]) formData.append("profile_pic", fileInput.files[0]);

  fetch("/update_profile", {method:"POST", body: formData})
    .then(res=>res.json())
    .then(data=>{
      if(data.status==="success"){
        document.getElementById("profile-pic").src = data.profile_pic;
        document.getElementById("username-input").value = data.username;
        alert("Profile updated!");
      }
    });
}

// Reactions
function react(post_id, emoji){
  fetch(`/react/${post_id}`, {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:`emoji=${emoji}`
  }).then(()=>loadTab('discover',true));
}

// Lazy load
window.addEventListener('scroll', ()=>{
  if((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100){
    const activeTab = document.querySelector('.tabs a.active')?.getAttribute('href')?.substring(1);
    if(activeTab) loadTab(activeTab);
  }
});

document.addEventListener('DOMContentLoaded', ()=>{ loadTab('discover', true); });
</script>
</head>
<body>

<!-- TOP NAV -->
<div class="top-nav">
  <span class="hamburger" onclick="toggleDropdown()">‚ò∞</span>
  <span class="logo">Seven33</span>
  <span class="actions">
    <a href="{{ url_for('add_post') }}" class="add-post">Add Post</a>
    <a href="{{ url_for('logout') }}" class="logout">Logout</a>
  </span>
  <div id="hamburgerDropdown" class="dropdown">
    <a href="{{ url_for('dashboard') }}">Home</a>
    <a href="{{ url_for('my_profile') }}">Profile</a>
    <a href="{{ url_for('settings_page') }}">Settings</a>
    <a href="{{ url_for('logout') }}">Logout</a>
  </div>
</div>

<!-- TABS -->
<div class="tabs">
  <a href="#discover" onclick="loadTab('discover',true)" class="active">Discover</a>
  <a href="#following" onclick="loadTab('following',true)">Following</a>
  <a href="#videos" onclick="loadTab('videos',true)">Videos</a>
  <a href="#profile" onclick="loadTab('profile',true)">Profile</a>
</div>

<!-- FEED -->
<div id="feed"></div>

<!-- Back to Home Button -->
<button id="backHomeBtn" onclick="loadTab('discover', true)">Back to Home</button>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <a href="#" data-tab="discover" class="active"><span>Home</span></a>
  <a href="#" data-tab="search"><span>Search</span></a>
  <a href="#" data-tab="messages"><span>Messages</span></a>
  <a href="#" data-tab="notifications"><span>Notifications</span></a>
  <a href="#" data-tab="profile"><span>Profile</span></a>
</div>

<script>
// Bottom nav click
document.querySelectorAll('.bottom-nav a').forEach(link=>{
  link.addEventListener('click', e=>{
    e.preventDefault();
    const tab = link.dataset.tab;
    document.querySelectorAll('.bottom-nav a').forEach(a=>a.classList.remove('active'));
    link.classList.add('active');
    loadTab(tab, true);
  });
});
</script>

</body>
</html>
